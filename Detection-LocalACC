# Detection Script: Check if local account "user" exists and is LAPS-ready
# Exit 0 = compliant, Exit 1 = remediation needed
# Run as: powershell.exe -ExecutionPolicy Bypass -File Detect-LAPSUser.ps1

$targetUser = "user"
$ErrorActionPreference = "Stop"

try {
    Write-Host "[DETECT] Checking user '$targetUser'..."

    # 1. Does the local user exist?
    $existingUser = Get-LocalUser -Name $targetUser -ErrorAction Stop
    Write-Host "[DETECT] User exists: $($existingUser.Name)"

    # 2. Must be enabled
    if (-not $existingUser.Enabled) {
        Write-Host "[DETECT] FAIL: User is disabled"
        exit 1
    }
    Write-Host "[DETECT] PASS: User is enabled"

    # 3. PasswordNeverExpires must be FALSE (required for LAPS)
    if ($existingUser.PasswordNeverExpires -eq $true) {
        Write-Host "[DETECT] FAIL: PasswordNeverExpires is TRUE"
        exit 1
    }
    Write-Host "[DETECT] PASS: PasswordNeverExpires is FALSE"

    # 4. Must be member of local Administrators
    # FIX: Use SID comparison instead of name matching
    $adminGroup = Get-LocalGroup -Name "Administrators" -ErrorAction Stop
    $adminMembers = Get-LocalGroupMember -Group $adminGroup -ErrorAction Stop

    $isAdmin = $false
    foreach ($member in $adminMembers) {
        if ($member.Name -like "*\$targetUser" -or $member.Name -eq $targetUser) {
            $isAdmin = $true
            break
        }
    }

    if (-not $isAdmin) {
        Write-Host "[DETECT] FAIL: User is not in Administrators group"
        exit 1
    }
    Write-Host "[DETECT] PASS: User is in Administrators group"

    # All checks passed
    Write-Host "[DETECT] SUCCESS: User is LAPS-ready"
    exit 0
}
catch [Microsoft.PowerShell.Commands.UserNotFoundException] {
    Write-Host "[DETECT] FAIL: User '$targetUser' does not exist"
    exit 1
}
catch {
    Write-Host "[DETECT] ERROR: $_"
    exit 1
}
