# Save this as C:\Temp\Remediate-LAPSUser.ps1

$userName = "user"

try {
    $user = Get-LocalUser -Name $userName -ErrorAction Stop
    Write-Host "[REMEDIATE] User '$userName' exists. Checking configuration..."
    
    # Fix PasswordNeverExpires
    if ($user.PasswordNeverExpires -eq $true) {
        Set-LocalUser -Name $userName -PasswordNeverExpires $false
        Write-Host "[REMEDIATE] SUCCESS: Set PasswordNeverExpires = FALSE"
    } else {
        Write-Host "[REMEDIATE] PasswordNeverExpires already FALSE"
    }
    
    # Check admin membership
    $admins = Get-LocalGroupMember -Group "Administrators" | Where-Object {$_.Name -like "*$userName"}
    if (-not $admins) {
        Add-LocalGroupMember -Group "Administrators" -Member $userName
        Write-Host "[REMEDIATE] SUCCESS: Added to Administrators"
    } else {
        Write-Host "[REMEDIATE] Already in Administrators group"
    }
    
    Write-Host "[REMEDIATE] User configuration complete"
    exit 0
    
} catch [Microsoft.PowerShell.Commands.UserNotFoundException] {
    Write-Host "[REMEDIATE] User '$userName' not found. Creating..."
    
    # Generate random password
    $password = -join ((65..90) + (97..122) + (48..57) + 33,64,35,36,37,94,38,42 | Get-Random -Count 16 | ForEach-Object {[char]$_})
    $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
    
    # Create user
    New-LocalUser -Name $userName -Password $securePassword -PasswordNeverExpires $false -Description "LAPS Managed Account"
    Write-Host "[REMEDIATE] SUCCESS: Created user '$userName'"
    
    # Add to Administrators
    Add-LocalGroupMember -Group "Administrators" -Member $userName
    Write-Host "[REMEDIATE] SUCCESS: Added to Administrators"
    
    Write-Host "[REMEDIATE] User created and configured for LAPS"
    exit 0
    
} catch {
    Write-Host "[REMEDIATE] ERROR: $_"
    exit 1
}
